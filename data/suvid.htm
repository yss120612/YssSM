<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Система автоматики Yss</title>
    <meta name="description" content="Версия 0.1">
    <meta name="author" content="Yss">
    <link href="/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/js/highstock.js"></script>
	<script type="text/javascript" src="/js/exporting.js"></script>
	<script type="text/javascript" src="/js/export-data.js"></script>
</head>
<body>
	<div class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			<a href="/" class="btn btn-info">Дом</a>
		</div>
				
		<div class="col-md-offset-1 col-md-10">
		<h3>Сувид</h3>
		</div>
	
		<div class="col-md-offset-1 col-md-10">
			<div id="TTARGET"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="TIMETARGET"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="TIMELEFT"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="TKUBE"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="TTRIAK"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="HPOWER"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="STA"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-5">
			<form action="/rectifyset" id="setTPause" class="form-inline">
				<div class="form-group">
					<label for="TMPPAUSE">Температура </label>
					<input type="input" class="form-control setdata" id="TMPPAUSE" aria-describedby="helpTmpPause">
				</div>
				<div class="form-group">
					<label for="TIMEPAUSE">Время (мин.) </label>
					<input type="input" class="form-control setdata" id="TIMEPAUSE" aria-describedby="helpTimePause">
				</div>
				<button type="submit" class="btn btn-primary">Установить</button>
			</form>
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="CHART"></div>		
		</div>
	</div>
	</div>
 
 <script type="text/javascript">
	$(document).ready(function(){
	process();
	
	
	var target=0;
	var chart1 = new Highcharts.Chart({
	title: {
		text: 'SuVid'
	},
	subtitle: {
		text: 'История изменения температуры в кубе и мощности тэна.'
	},
	yAxis:[{
	
	title: {
        text: 'Температура'
		},
		 plotLines: [{
                value: 60,
                color: 'green',
				id: 'tmp',
                dashStyle: 'shortdash',
                width: 1,
                label: {
                    text: 'Заданная температура'
                }
            }],
		 labels: {
			formatter: function() {
            return this.value + '°C'
			}
		 }
		},{
		title: {
        text: 'Мощность'
		},
        labels: {
			formatter: function() {
            return this.value + '%'
			}
		 },
		 opposite: true
		}],
        xAxis: {
            type: 'datetime',
			
			 
        },	
		
		time:{
		useUTC:false,
		},
		
        chart: {
            renderTo: 'CHART',
			type: 'spline', 
			 events: {
            load: function () {
			
			 var series0 = this.series[0];
			 var series1 = this.series[1];
			 var ax = this.yAxis[0];
			 
			setInterval(function(){
			$.getJSON("/suviddata", function(lst) {
			var shift = series0.data.length > 99;
			var y0= parseFloat(lst['kube_data']);
			var y1= parseFloat(lst['heater_data']);
			var t=parseFloat(lst['ttarget_data']);
			var x=(new Date()).getTime();
			if (target!=t)
			{
			target=t;
			ax.removePlotLine('tmp');
			ax.addPlotLine({
				value: parseFloat(lst['ttarget_data']),
                color: 'green',
				id: 'tmp',
                dashStyle: 'shortdash',
                width: 1,
                label: {
                    text: 'Заданная температура'
                }
			});
			}
			series0.addPoint([x,y0],true,shift); 
			series1.addPoint([x,y1],true,shift); 
			});
			}, 30000);
            }
        }
        },
			
		
        series: [{
			name:'Температура',
            data: [20],
			yAxis: 0,
            pointStart: (new Date()).getTime()-10000,
           // pointInterval: 10 * 1000
        },{
			name:'Мощность тэна',
            data: [40],
			yAxis: 1,
			color: '#FF0000',
            pointStart: (new Date()).getTime()-10000,
		}]
    });
	
	$('.setdata').focus(function() {
		$(this).addClass("focus");
	});
	$('.setdata').blur(function() {
		$(this).removeClass("focus");
	});
		  
	$('#setTPause').submit(function(){  
                $.ajax({  
                    type: "POST",  
                    url: "/suvidset",  
                    data: "TMP="+$("#TMPPAUSE").val()+"&TIME="+$("#TIMEPAUSE").val(),  
                    success: function(html){  
                       
                    }  
                });  
                return false;  
            });  
	
	});
	
	function randomInteger(min, max) {
    var rand = min - 0.5 + Math.random() * (max - min + 1)
    rand = Math.round(rand);
    return rand;
  }
	
		
	function process(){
		$.getJSON(
		"/suviddata",
		function(data){
		$('#TTARGET').html('Температура поддерживаемая <b>'+data['ttarget_data']+'&deg;C</b>');
		if (!$('#TMPPAUSE').hasClass('focus')){
		$('#TMPPAUSE').val(data['ttarget_data']);
		}
		$('#TIMETARGET').html('Время заданное <b>'+data['timetarget_data']+' мин.</b>');
		if (!$('#TIMEPAUSE').hasClass('focus')){
		$('#TIMEPAUSE').val(data['timetarget_data']);
		}
		$('#TKUBE').html('Температура в кубе <b>'+data['kube_data']+'&deg;C</b>');
		$('#TTRIAK').html('Температура радиатора нагревателя <b>'+data['cooler_data']+'&deg;C</b>');
		$('#HPOWER').html('Мощность нагревателя <b>'+data['heater_data']+'%</b>');
		$('#TIMELEFT').html('Осталось <b>'+data['time_data']+'</b>');
		$('#STA').html('Состояние <b>'+data['state_data']+'</b>');
		});
		setTimeout('process()',3000);
	};
		</script>
	</body>
</html>