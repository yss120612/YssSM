<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Система автоматики Yss</title>
    <meta name="description" content="Версия 0.1">
    <meta name="author" content="Yss">
    <link href="/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/js/highstock.js"></script>
	<script type="text/javascript" src="/js/exporting.js"></script>
	<script type="text/javascript" src="/js/export-data.js"></script>
</head>
<body>
	<div class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			<a href="/" class="btn btn-info">Дом</a>
		</div>
				
		<div class="col-md-offset-1 col-md-10">
		<h3>Затирание</h3>
		</div>
	
		<div id="PAUSE1">
		<div class="col-md-offset-1 col-md-10">
		<h5>1я пауза</h5>
			<div id="TTARGET1"></div>		
		</div>
		<div class="col-md-offset-1 col-md-10">
			<div id="TIMETARGET1"></div>		
		</div>
		
		</div>
		<div id="PAUSE2">
		<div class="col-md-offset-1 col-md-10">
		<h5>2я пауза</h5>
			<div id="TTARGET2"></div>		
		</div>
		<div class="col-md-offset-1 col-md-10">
			<div id="TIMETARGET2"></div>		
		</div>
		
		</div>
		<div id="PAUSE3">
		<div class="col-md-offset-1 col-md-10">
		<h5>3я пауза</h5>
			<div id="TTARGET3"></div>		
		</div>
		<div class="col-md-offset-1 col-md-10">
			<div id="TIMETARGET3"></div>		
		</div>
		
		</div>
		<div id="PAUSE2">
		<div class="col-md-offset-1 col-md-10">
		<h5>4я пауза</h5>
			<div id="TTARGET4"></div>		
		</div>
		<div class="col-md-offset-1 col-md-10">
			<div id="TIMETARGET4"></div>		
		</div>
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="PHASE"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="TIMELEFT"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="TKUBE"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="TTRIAK"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="HPOWER"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-10">
			<div id="STA"></div>		
		</div>
		
		<div class="col-md-offset-1 col-md-5">
			<form action="/brewingset" id="setTPause1" class="form-inline">
			 <div class="form-group col-md-4">
				<label for="inputState">Настроить</label>
					<select id="inputState" class="form-control setdata" >
					<option value="1">Термопауза 1</option>
					<option value="2">Термопауза 2</option>
					<option value="3">Термопауза 3</option>
					<option value="4">Термопауза 4</option>
					<option value="5">Чиллер</option>
				</select>
				</div>
				<div class="form-group" id="PAUSEDIV">
				<div class="form-group">
					<label for="TMPPAUSE">Температура </label>
					<input type="input" class="form-control setdata" id="TMPPAUSE" aria-describedby="helpTmpPause">
				</div>
				<div class="form-group">
					<label for="TIMEPAUSE">Время (мин.) </label>
					<input type="input" class="form-control setdata" id="TIMEPAUSE" aria-describedby="helpTimePause">
				</div>
				</div>
				<div class="form-check" id="CILLERDIV">
					<label class="form-check-label">
						<input class="form-check-input setdata" type="checkbox" id="CHILLER"> Чиллер
					</label>
				</div>
				
				<input type="hidden" id="lock1" value="1">
				<button type="submit" class="btn btn-primary">Установить</button>
			</form>
		</div>
		
				
		<div class="col-md-offset-1 col-md-10">
			<div id="CHART"></div>		
		</div>
	</div>
	</div>
 
 <script type="text/javascript">
	$(document).ready(function(){
	process();
	
	
	var target=0;
	var chart1 = new Highcharts.Chart({
	title: {
		text: 'SuVid'
	},
	subtitle: {
		text: 'История изменения температуры в кубе и мощности тэна.'
	},
	yAxis:[{
	
	title: {
        text: 'Температура'
		},
		 plotLines: [{
                value: 60,
                color: 'green',
				id: 'tmp',
                dashStyle: 'shortdash',
                width: 1,
                label: {
                    text: 'Заданная температура'
                }
            }],
		 labels: {
			formatter: function() {
            return this.value + '°C'
			}
		 }
		},{
		title: {
        text: 'Мощность'
		},
        labels: {
			formatter: function() {
            return this.value + '%'
			}
		 },
		 opposite: true
		}],
        xAxis: {
            type: 'datetime',
			
			 
        },	
		
		time:{
		useUTC:false,
		},
		
        chart: {
            renderTo: 'CHART',
			type: 'spline', 
			 events: {
            load: function () {
			
			 var series0 = this.series[0];
			 var series1 = this.series[1];
			 var ax = this.yAxis[0];
			 
			setInterval(function(){
			$.getJSON("/suviddata", function(lst) {
			var shift = series0.data.length > 99;
			var y0= parseFloat(lst['kube_data']);
			var y1= parseFloat(lst['heater_data']);
			var t=parseFloat(lst['ttarget_data']);
			var x=(new Date()).getTime();
			if (target!=t)
			{
			target=t;
			ax.removePlotLine('tmp');
			ax.addPlotLine({
				value: parseFloat(lst['ttarget_data']),
                color: 'green',
				id: 'tmp',
                dashStyle: 'shortdash',
                width: 1,
                label: {
                    text: 'Заданная температура'
                }
			});
			}
			series0.addPoint([x,y0],true,shift); 
			series1.addPoint([x,y1],true,shift); 
			});
			}, 30000);
            }
        }
        },
			
		
        series: [{
			name:'Температура',
            data: [20],
			yAxis: 0,
            pointStart: (new Date()).getTime()-10000,
           // pointInterval: 10 * 1000
        },{
			name:'Мощность тэна',
            data: [40],
			yAxis: 1,
			color: '#FF0000',
            pointStart: (new Date()).getTime()-10000,
		}]
    });
	
	$('.setdata').focus(function() {
		$("#lock").addClass("focus");
	});
	$('.setdata').blur(function() {
		$("#lock").removeClass("focus");
	});
		  
	$('#setTPause').submit(function(){  
			if ($("#inputState").val()=="5"){	
			$.ajax({  
                    type: "POST",  
                    url: "/suvidset",  
                    data: "CHILLER="+$("#CHILLER").is(':checked')?"1":"2"+"&PART="+$("#inputState").val(),  
                    success: function(html){  
                       
                    }  
			}
			else{
                $.ajax({  
                    type: "POST",  
                    url: "/suvidset",  
                    data: "TMP="+$("#TMPPAUSE").val()+"&TIME="+$("#TIMEPAUSE").val()+"&PART="+$("#inputState").val(),  
                    success: function(html){  
                       
                    }  
				}
                });  
                return false;  
            });  
	
	$("#inputState").change(function() {
		if ($("#inputState").val()=="5"){
		$("PAUSEDIV").hide();
		$("CHILLERDIV").show();
		}
		else
		{
		$("PAUSEDIV").show();
		$("CHILLERDIV").hide();
		}
	});
	
	$("#inputState").val("1");
	
	});
	
	function randomInteger(min, max) {
    var rand = min - 0.5 + Math.random() * (max - min + 1)
    rand = Math.round(rand);
    return rand;
  }
	
		
	function process(){
		$.getJSON(
		"/brewingdata",
		function(data){
		$('#TTARGET1').html('Температура поддерживаемая <b>'+data['ttarget1_data']+'&deg;C</b>');
		$('#TIMETARGET1').html('Время заданное <b>'+data['timetarget1_data']+' мин.</b>');
		$('#TTARGET2').html('Температура поддерживаемая <b>'+data['ttarget1_data']+'&deg;C</b>');
		$('#TIMETARGET2').html('Время заданное <b>'+data['timetarget1_data']+' мин.</b>');
		$('#TTARGET3').html('Температура поддерживаемая <b>'+data['ttarget1_data']+'&deg;C</b>');
		$('#TIMETARGET3').html('Время заданное <b>'+data['timetarget1_data']+' мин.</b>');
		$('#TTARGET4').html('Температура поддерживаемая <b>'+data['ttarget1_data']+'&deg;C</b>');
		$('#TIMETARGET4').html('Время заданное <b>'+data['timetarget1_data']+' мин.</b>');
		
		
		for (var i = 1; i <= 4; i++) {
			if (i==pd){
			if (!$("#PAUSE"+i).hasClass("warning")) $("#PAUSE"+i).addClass("warning");
			}else{
			if ($("#PAUSE"+i).hasClass("warning")) $("#PAUSE+i").removeClass("warning");
			}
		}
		
		
		
		if (!$('#lock').hasClass('focus')){
		if ($("#inputState").val()=="1"){
		$('#TMPPAUSE').val(data['ttarget1_data']);
		$('#TIMEPAUSE').val(data['timetarget1_data']);
		} else if ($("#inputState").val()=="2"){
		$('#TMPPAUSE').val(data['ttarget2_data']);
		$('#TIMEPAUSE').val(data['timetarget2_data']);
		} else if ($("#inputState").val()=="3"){
		$('#TMPPAUSE').val(data['ttarget3_data']);
		$('#TIMEPAUSE').val(data['timetarget3_data']);
		} else if ($("#inputState").val()=="4"){
		$('#TMPPAUSE').val(data['ttarget4_data']);
		$('#TIMEPAUSE').val(data['timetarget4_data']);
		}
		$('#CHILLER').prop('checked',data['chiller_data']!=0)
		}
		
		
		
		
		$('#TKUBE').html('Температура в кубе <b>'+data['kube_data']+'&deg;C</b>');
		$('#PHASE').html('Фаза затирания <b>'+pd+'</b>');
		$('#TTRIAK').html('Температура радиатора нагревателя <b>'+data['cooler_data']+'&deg;C</b>');
		$('#HPOWER').html('Мощность нагревателя <b>'+data['heater_data']+'%</b>');
		$('#TIMELEFT').html('Осталось <b>'+data['time_data']+'</b>');
		$('#STA').html('Состояние <b>'+data['state_data']+'</b>');
		});
		setTimeout('process()',3000);
	};
		</script>
	</body>
</html>